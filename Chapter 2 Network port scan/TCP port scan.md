포트 스캔은 불법이다. 허가되지 않은 사용자가 상용 시스템에 침투하려는 시도 자체를 대부분의 국가에서 불법으로 지정하고 있다. 합법적으로 포트 스캐닝을 하여려면 자신이 권한을 가진 시스템에서만 사용해야 한다.

🧸 **사용 도구** : ```Nmap```

# ⚖️ TCP port scan
TCP 포트 스캔은 3-way-handshake를 이용하여 포트의 개방 여부를 파악한다.

예를 들어 **열려 있지 않은 포트**로 ```SYN```을 전송하면 서버 측에서는 포트가 열려 있지 않은 상태라는 것을 알려주고자 ```RST-ACK``` 패킷으로 응답한다.
반대로 **열려 있는 포트**로 ```SYN```을 전송하면 서버 측에서 ```SYN-ACK``` 패킷으로 응답해준다.

이후에 정상적인 3-way-handshake가 이루어 지는데, 이 때 서버의 접속 로그에 남을 수도 있다. 공격자의 입장에서는 치명적인 문제가 된다.

만약 방화벽이나 iptables와 같은 **차단 정책**에 포트 스캔이 차단되었을 때는 TCP나 UDP 관계없이 어떠한 패킷도 응답하지 않는다.

포트 상태|공격자|공격 대상|공격자
:---:|:---:|:---:|:---:
열린 포트|```SYN```|```SYN-ACK```|```ACK```
닫힌 포트|```SYN```|```RST-ACK```|```-```
차단 정책|```SYN```|```-```|```-```

TCP 포트 스캔에서 로그를 남기지 않도록 스캔하는 방법을 ```Stealth 스캔```이라고 한다. 3-way-handshake 과정을 이용하며, TCP Half open 스캔과 Fin, Xmas, Null 스캔 등의 방법이 있다.

## 💡 TCP SYN scan
```책의 패킷 샘플 이용```

Nmap을 이용한 TCP SYN 스캔의 기본 명령어는 ```nmap -sT [대상 서버 IP]``` 이다. (뒤에 ```-p 포트``` 지정을 할 수 있다.)

```$ nmap -sT 10.40.201.255 -p 1-65535```

```tcp.stream eq 0``` tcp stream을 이용해 필터링하면, 열려 있는 포트로 전송된 SYN 패킷은 3-way-handshake 과정을 통해 연결이 생성된다. 이후에 RST-ACK 패킷을 전송하여 강제로 연결을 끊는 형태인 것을 확인할 수 있다.

![스크린샷 2022-03-24 오후 1 59 28](https://user-images.githubusercontent.com/66156026/159845534-dfd1fc2e-c65e-4674-8260-4fb99b9303a0.png)

```tcp.stream eq 2``` 하지만 닫혀 있는 포트는 SYN 패킷에 RST-ACK 패킷이 응답하여 포트가 열려 있지 않다는 것을 알 수 있다.

![스크린샷 2022-03-24 오후 2 04 36](https://user-images.githubusercontent.com/66156026/159845988-42efd4ad-7926-4784-aeac-16e3c313d5a7.png)

와이어샤크 메뉴에서 ```[Statistic] - [Conversations]```을 이용하면 어떤 포트를 대상으로 스캔이 시도되었는지 좀 더 쉽게 확인할 수 있다.

![스크린샷 2022-03-24 오후 2 09 00](https://user-images.githubusercontent.com/66156026/159846593-23a1e717-1f90-4c3d-afc4-dab21055af35.png)

> **Nmap 실행 결과 파일 저장하기** <br/>
> ```--packet-trace``` : Nmap이 보내거나 받은 모든 패킷의 요약을 출력 <br/>
> ```-oN <파일이름>``` : <파일이름>으로 지정한 파일에 결과 보고서를 저장한다. <br/>
> ```-oX <파일이름>``` : <파일이름>으로 지정한 파일에 XML 형식으로 결과를 저장한다. <br/>
> ```-oG <파일이름>``` : <파일이름>으로 지정한 파일에 grepable 형식으로 저장한다.

## 💡 TCP stealth scan
위에 사용한 TCP SYN 스캔은 정상적인 연결로 포트 개폐 여부를 판단하기 때문에 로그에 남는다. 하지만 공격자는 주로 정상적인 3-way-handshake 과정이 완료되지 않게 하여 로그가 남지 않도록 포트 스캔을 하는데,
이런 방식을 ```Stealth 스캔```이라고 한다.

### 💡 TCP half open scan
TCP에서 Half open이라 함은 3-way-handshake 과정에서 SYN 패킷을 받은 서버가 SYN-ACK 패킷을 응답하고서, 언젠가 ACK 패킷이 돌아올 것을 기다리는 ```'반쯤 열린'``` 상태를 말한다.
TCP half open 스캔도 **마지막의 ACK 패킷을 전송하지 않아서** 3-way-handshake 과정을 완성하지 않는 데서 나온 이름이다.

Nmap을 이용한 TCP half open 스캔의 기본 명령어는 ```nmap -sS [대상 서버 IP]``` 이다.
TCP SYN 스캔을 한 결과와 **같은 결과값**을 보인다.

```$ nmap -sS 10.40.201.255 -p 1-65535```

와이어샤크를 통해 패킷의 흐름을 확인했을 때, 마찬가지로 다수의 SYN과 RST-ACK 패킷이 확인된다.

하지만 열려 있는 패킷의 흐름을 확인하면 SYN 스캔과의 차이점이 보인다.
서버로부터 수신된 ```SYN-ACK``` 패킷에 ```RST``` 패킷으로 **응답**하여 3-way-handshake 과정을 맺지 않는다는 것을 확인할 수 있다.
로그를 남기지 않기 위해 3-way-handshake 과정을 맺지 않고, ```SYN-ACK``` 패킷의 **수신 여부**에 따라 특정 포트가 열려 있음을 확인하는 스캐닝 방식이다.

![스크린샷 2022-03-24 오후 2 59 06](https://user-images.githubusercontent.com/66156026/159852067-c4e9bab5-663a-4cc7-9d89-493e5a6587b1.png)

열려 있지 않은 포트로부터 ```RST-ACK``` 패킷으로 응답받는 것은 TCP SYN 스캔과 동일하다.

![스크린샷 2022-03-24 오후 3 00 54](https://user-images.githubusercontent.com/66156026/159852319-fd2be277-74df-4e38-816d-f4d0464680ff.png)

다음은 **TCP half open 스캔의 흐름**이다.

포트 상태|공격자|공격 대상|공격자
:---:|:---:|:---:|:---:
열린 포트|```SYN```|```SYN-ACK```|```RST```
닫힌 포트|```SYN```|```RST-ACK```|```-```
차단 정책|```SYN```|```-```|```-```

### 💡 FIN scan / Xmas scan / Null scan
윈도우를 비롯해 최근의 유닉스 시스템을 대상으로 이들 스캔은 **정상적으로 동작하지 않았다.**

유형별로 패킷의 TCP Flags는 조금씩 다르지만 스캔의 원리는 같다. **열려 있는 포트의 경우에는 아무런 패킷이 응답하지 않으며, 열려 있지 않은 포트의 경우에는 ```RST-ACK``` 패킷이 응답**한다.

포트 상태|공격자|공격 대상
:---:|:---:|:---:
열린 포트|```FIN``` ```Xmas``` ```Null```|```-```
닫힌 포트|```FIN``` ```Xmas``` ```Null```|```RST-ACK```
차단 정책|```FIN``` ```Xmas``` ```Null```|```-```

```FIN``` 스캔은 TCP FIN 패킷을 전송하며 열려 있는 포트는 아무런 응답이 없는 특징을 이용한 스캔 방식이었지만 현재는 유효하지 않다. Nmap에서 사용하는 옵션 값은 ```-sF``` 이다.

```XMAS``` 스캔은 TCP Flag 중, FIN/PSH/URG 패킷을 전송하며 열려 있는 포트는 아무런 응답이 없는 특징을 이용한 스캔 방식이었지만 현재는 유효하지 않다. Nmap에서 사용하는 옵션 값은 ```-sX``` 이다.

```NULL``` 스캔은 TCP Flag를 설정하지 않고 전송하며 열려 있는 포트는 아무런 응답이 없는 특징을 이용한 스캔 방식이었지만 현재는 유효하지 않다. Nmap에서 사용하는 옵션 값은 ```-sN``` 이다.
