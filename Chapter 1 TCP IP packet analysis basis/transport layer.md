# ⚖️ Transport layer
전송 계층은 네트워크 통신의 양 끝단(End to end)의 사용자들이 신뢰성 있는 데이터를 주고 받도록 하고, 상위 계층들의 데이터 전달에 대해 유효성이나 효율성을 보장해준다.
특정 연결에 대해 유효성을 제어하기 때문에 패킷의 내용이 유효한지 확인하고 전송에 실패한 패킷들은 재전송하게 된다.
전송 계층에서는 신뢰성이 보장되는 ```TCP```, 신뢰성이 보장되지 않는 ```UDP```로 구분된다.

## 💡 TCP Protocol
TCP 프로토콜의 가장 중요한 특징은 상대방에게 **데이터를 정확하게 전달**할 수 있다는 점이다. 데이터를 전달하기 전 준비 단계인 **세션 연결 과정**을 거쳐야 한다.
신뢰성이 요구되는 인터넷 뱅킹, e-mail 등에 쓰인다.

- 🧸 **통신 시작(세션 연결)**

세션을 연결하는 절차인 ```3-way-handshake``` 과정이다. 상대방의 요청 확인 및 승낙 등의 작업을 수행한다.

![SYN-ACK 1](https://user-images.githubusercontent.com/66156026/159155905-2133174e-91a0-46d7-ad5b-ae84cc3e4a02.jpg)

- 🧸 **데이터 송수신**

사용자는 홈페이지 초기 파일을 요청하고, 웹 서버는 요청한 초기 파일을 사용자에게 전달하는 구조이다. PSH를 통해 데이터를 요청하고 전달한다.

![SYN-ACK 2](https://user-images.githubusercontent.com/66156026/159155907-4adae124-c232-4308-b16a-a1b72c96cf15.jpg)

- 🧸 **통신 종료(세션 종료)**

```4-way-handshake``` 세션을 종료하는 과정이다. 통신을 시작한 쪽에서 FIN-ACK을 전달하여 통신 해제를 요청하면, 수신자도 같은 방식으로 상호 합의하여 통신을 종료한다.

![FIN-ACK 1](https://user-images.githubusercontent.com/66156026/159155994-adc04bfd-ad15-4658-9422-2bf267d4b2e9.jpg)

<br/>

TCP와 UDP 프로토콜은 **포트(port) 고유 번호**를 할당하여 어떤 서비스에 사용할지 결정한다. 사용하는 포트의 범위는 ```1 ~ 65,535```번까지 이며, 이 중 ```1 ~ 1,023```까지는 **잘 알려진(Well-known) 포트**로 미리 할당되어 있는 포트이다.
임의로 포트 번호를 사용하고자 할 경우에는 잘 알려진 포트 이외의 포트를 사용해야 한다.

포트 번호|서비스
:---:|:---:|
```80```|HTTP
```443```|HTTPS
```22```|SSH
```23```|TELNET
```53```|DNS

### 💡 TCP Header

![tcp header](https://user-images.githubusercontent.com/66156026/159156484-648ff064-4b3c-4746-85c7-d7fadfdfb422.png)

- 🧸 **Source port number(16비트)**

송신자 포트 번호가 할당된다. 예를 들어 웹 브라우저를 통해 구글에 접속하면 로컬 PC의 출발지 포트는 1,024번 이상의 포트 번호로 임의 할당하여 구글 웹 서버에 접속하게 된다.

- 🧸 **Destination port number(16비트)**

접속하고자 하는 목적지 서버의 포트 번호가 할당된다. 예를 들어 구글에 접속하면 목적지 포트는 https로 443번이 된다.

- 🧸 **Sequence number(32비트)**

TCP에서는 패킷을 전송할 때마다 **패킷에 고유한 번호**를 부여하는데 이를 시퀀스 번호라고 한다.
SYN이나 FIN을 전송하면 전송자의 다음 시퀀스 번호는 1씩 증가하며, 데이터를 전송하면 이후의 시퀀스 번호는 데이터의 크기만큼 증가한다.

- 🧸 **Acknowledge number(32비트)**

패킷을 오류 없이 수신했을 때 송신자에게 **정상 수신 여부**를 알려 주기 위해 사용하는 번호이다. SYN이나 FIN을 수신하면 수신자의 승인 번호는 1씩 증가하고, 데이터를 수신하면 데이터의 크기만큼 증가한다.
다른 의미로는 다음에 송신자가 전송할 시퀀스 번호는 몇 번이다라는 것을 송신자에게 알려주는 의미가 될 수 있다.

- 🧸 **Header Length(Offset)**

TCP 헤더 길이를 제공한다.

- 🧸 **Reserved**

예약된 필드로 사용되지 않는 경우 ```0```의 값으로 설정된다.

- 🧸 **Control Flags**

플래그는 6개 비트로 구성되어 있으며, 해당 비트 조합을 통해 **통신 상태**를 표시한다.

Flags|설명
:---:|:---:
```URG```|긴급 요청
```ACK```|응답 메시지
```PSH```|수신한 데이터를 애플리케이션 계층으로 즉시 전달
```RST```|강제 세션 종료
```SYN```|연결 요청
```FIN```|정상 세션 종료

- 🧸 **Windows size**

**한 번에 받을 수 있는 패킷 크기**를 의미한다. 두 PC 간의 윈도우 크기가 다를 경우 ```작은 크기```에 맞추어 데이터를 송신한다.

- 🧸 **Header checksum**

**헤더 값의 에러 발생 여부를 검사**하기 위해 사용한다.
첫 번째로 IP 헤더와 TCP 헤더의 일부 값, 두 번째로 TCP 헤더 값, 세 번째로 실제 TCP 데이터를 더한 값에 보수화 과정을 통해 계산한다. 모든 합산은 16진수로 이루어진다.

- 🧸 **Urgent pointer**

플래그 필드에 ```URG``` 플래그가 설정된 패킷에서만 유효하다.

- 🧸 **Options and Padding**

Options는 상세한 조정 기능을 위해 예약되어 있고, Padding은 가변적인 헤더의 크기를 일정하게 맞추기 위해 사용한다.


## 💡 UDP Protocol
TCP에 비해 **단순한 헤더 정보**를 가지고 있고 **속도 또한 빠르지만**, **신뢰성은 보장되지 않는다**.
UDP는 데이터 전달에만 목적이 있다. 상대방의 준비 상태에는 관심도 없고 정상 수신 여부에도 관심이 없다.
실시간 인터넷 방송과 전화와 같은 일부 데이터가 손상되어도 크게 영향 받지 않는 서비스에 활용되는 프로토콜이다.

- 🧸 **데이터 정상 전달**

세션 연결 없이 데이터를 전달한다.

![UDP packet sent 1](https://user-images.githubusercontent.com/66156026/159283937-9ba05f37-d1dd-4e74-b4d7-381ea6766405.jpg)

- 🧸 **UDP 전달 중 데이터 손실 발생**

데이터 전달 중 손실이 발생할 경우, 다시 요청하지 않고 해당 데이터를 폐기한다.

![UDP packet sent 2](https://user-images.githubusercontent.com/66156026/159283948-710955cf-7bd5-466b-ac86-5066fdbab235.jpg)

- 🧸 **잘못된 포트로 UDP 접속 시도**

대상 서버가 제공하지 않는 포트로 접속을 시도하는 경우, UDP에는 에러 처리 기능이 없어 ICMP 메시지를 전달하여 접근이 불가함을 알린다.
`````'목적지 도달 불가(Port unreachable)'````` 메시지를 상대방에게 전달한다.

![UDP packet sent 3](https://user-images.githubusercontent.com/66156026/159283957-eee07fdb-5451-416e-b181-78dc766588d9.jpg)

